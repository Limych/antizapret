# AntiZapret

Прозрачный обход блокировок для локальной сети.

Мне это решение особенно нравится тем, что оно корректно отрабатывает любой трафик. В том числе и HTTPS. При этом никаких настроек на клиентах делать не надо.

Система отлично работает с роутерами на базе opnSense (на роутерах на базе pfSense не проверял, но также должно работать без проблем). Возможно, также будет работать с другими роутерами, т.к. используются только базовые возможности файрвола.

## Установка и настройка

*NB.* Для настройки системы понадобится доступ к командной строке через консоль или SSH. все команды надо исполнять от имени root, т.к. иначе часть не сработает.
1.  Установите и настройте Tor.

    Для этого в opnSense сначала установите плагин `os-tor` через вкладку System > Firmware > Plugins. После перейдите на вновь появившуюся вкладку Services > Tor > Configuration и настройте его:\
    Включить Advanced mode в верхнем левом углу.\
    Включить Enable.\
    При желании указать интерфейсы локальной сети в Listen Interfaces (надо, если вы планируете использовать Tor как-то ещё; для данного обхода блокировок поле можно оставить пустым)\
    Включить Enable Transparent Proxy.

2.  Настройте регулярное обновление списков блокировки.\
    Путей тут несколько:

    Для opnSense необходимо файл `opnsense/actions_antizapret.conf` скопировать в каталог `/usr/local/opnsense/service/conf/actions.d/`, после чего обновить демон настроек, выполнив в консоле команду `service configd restart` или через панель управления перезапустив демон `configd` (System Configuration Daemon).\
    После этого в настройках cron (System > Settings > Cron) добавить новую задачу на ежесуточное обновление списка:\
    Command = «Renew AntiZapret IP-list».
   
    Для других систем необходимо в cron добавить что-то типа
    ```
    0   0   *   *   *   /root/antizapret/antizapret.pl >/usr/local/etc/ipfw_antizapret.dat
    ```

3.  Чтобы не ждать сутки первого обновления списка, в консоле исполняем команду
    ```
    /root/antizapret/antizapret.pl >/usr/local/etc/ipfw_antizapret.dat
    ```
   
4.  Настройте правила файрвола.

    Сначала в настройках файрвола на вкладке Firewall > Aliases создайте алиас для удобства использования списка.\
    Name = AntiZapret_IPs\
    Type = URL Table (IPs)\
    Expiration > Hours = 3\
    Content = `/usr/local/etc/ipfw_antizapret.dat`
    
    Дальше на вкладке Firewall > NAT > Port Forward создаём новое правило:\
    Interface = LAN\
    Protocol = TCP\
    Destination = AntiZapret_IPs\
    Destination port range = any\
    Redirect target IP = 127.0.0.1 (адрес, где запущен Tor; в данном случае — та же машина)\
    Redirect target port = 9040\
    Description = Anti-Zapret
    
5.  Всё. Через некоторое время система сама подгрузит список и файрвол начнёт прозрачно перенаправлять любые обращения к заблокированным сайтам на Tor. В то же время весь прочий трафик будет идти напрямую, как обычно.
